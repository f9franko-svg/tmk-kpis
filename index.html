<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TMK KPIs</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a30;
      --card2:#111f3a;
      --text:#e9eefc;
      --muted:#a9b4d0;
      --border:rgba(255,255,255,.10);
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --accent:#60a5fa;
    }
    body{
      font-family:system-ui,Arial;
      max-width:820px;margin:28px auto;padding:0 14px;
      background:linear-gradient(180deg,#070b14 0%, #0b1220 60%, #070b14 100%);
      color:var(--text);
    }
    h2{letter-spacing:.3px;margin:6px 0 14px 0}
    .muted{color:var(--muted);font-size:12px}

    .card{
      background:linear-gradient(180deg,var(--card) 0%, var(--card2) 100%);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      margin:14px 0;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }

    input,button,select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      margin:7px 0;
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(233,238,252,.45)}
    button{
      cursor:pointer;
      background:linear-gradient(90deg, rgba(96,165,250,.9) 0%, rgba(34,197,94,.75) 100%);
      border:none;
      font-weight:700;
    }
    button:hover{filter:brightness(1.05)}
    button:disabled{opacity:.6;cursor:not-allowed}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:center}
    .hide{display:none}

    .kpisGrid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:10px;
    }
    .kpi{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 12px;
      border-radius:14px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
    }
    .kpi strong{font-size:14px}
    .badge{
      padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;
      border:1px solid var(--border);
    }
    .good{color:var(--good)}
    .warn{color:var(--warn)}
    .bad{color:var(--bad)}

    .sectionTitle{
      margin:18px 0 6px 0;
      font-weight:800;
      letter-spacing:.2px;
    }
    .chartWrap{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      position:relative; /* IMPORTANTE: estabiliza sizing */
    }

    /* IMPORTANTE: fuerza altura real del canvas */
    #salesChart{ height:280px !important; width:100% !important; }

    .inline2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
  </style>
</head>

<body>
  <h2>TMK KPIs</h2>
  <p class="muted">"Cree que puedes y estarás a mitad de camino"</p>

  <div id="loginCard" class="card">
    <h3>Iniciar sesión</h3>
    <input id="email" placeholder="Email" autocomplete="username" />
    <input id="password" placeholder="Contraseña" type="password" autocomplete="current-password" />
    <button id="btnLogin">Entrar</button>
    <div id="loginMsg" class="muted"></div>
  </div>

  <div id="appCard" class="card hide">
    <div class="row">
      <div>
        <h3>RESULTADOS TMK - GEA GUATEMALA</h3>
        <div class="muted" id="userInfo"></div>
      </div>
      <div>
        <button id="btnLogout">Cerrar sesión</button>
      </div>
    </div>

    <label>Fecha</label>
    <input id="kpiDate" type="date" />

    <label>Periodo</label>
    <select id="period">
      <option value="daily">Diario</option>
      <option value="monthly">Mes (acumulado)</option>
    </select>

    <label>Campaña</label>
    <select id="campaign"></select>

    <button id="btnLoad">Cargar KPIs</button>

    <div id="kpis"></div>
    <div class="muted" id="status"></div>

    <!-- ==== Supervisor Zone ==== -->
    <div id="supervisorZone" class="hide">
      <div class="sectionTitle">Gráficas</div>

      <label>Tipo de gráfica</label>
      <select id="chartMode">
        <option value="monthly">Mes (comparación mes a mes)</option>
        <option value="daily">Día (tendencia día a día)</option>
      </select>

      <label>Alcance</label>
      <select id="scope">
        <option value="me">Mi usuario</option>
        <option value="all">Todos</option>
        <option value="operator">Operador</option>
      </select>

      <div id="operatorPickWrap" class="hide">
        <label>Operador</label>
        <select id="operatorPick"></select>
      </div>

      <div class="inline2">
        <div>
          <label>Desde</label>
          <input id="chartFrom" type="date" />
        </div>
        <div>
          <label>Hasta</label>
          <input id="chartTo" type="date" />
        </div>
      </div>

      <div class="chartWrap">
        <div class="muted" id="chartTitle">Ventas</div>
        <canvas id="salesChart"></canvas>
      </div>

      <button id="btnLoadChart">Cargar gráfico</button>
      <div class="muted" id="chartStatus"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    // ===== Supabase =====
    const SUPABASE_URL = "https://sjxqhlhvsdxgahpndxcc.supabase.co";
    const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_IvVkMu9brJvX19qfqoBlxA_3cp2Qq85";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

    const $ = (id) => document.getElementById(id);

    const loginCard = $("loginCard");
    const appCard = $("appCard");
    const loginMsg = $("loginMsg");
    const status = $("status");
    const kpisDiv = $("kpis");
    const campaignSel = $("campaign");
    const kpiDate = $("kpiDate");
    const userInfo = $("userInfo");
    const periodSel = $("period");

    const supervisorZone = $("supervisorZone");
    const chartModeSel = $("chartMode");
    const scopeSel = $("scope");
    const operatorPickWrap = $("operatorPickWrap");
    const operatorPick = $("operatorPick");
    const chartStatus = $("chartStatus");
    const chartTitle = $("chartTitle");
    const chartFrom = $("chartFrom");
    const chartTo = $("chartTo");

    const ALL_CAMPAIGNS_VALUE = "__ALL__";

    // fecha por defecto: hoy
    const today = new Date();
    const todayStr = today.toISOString().slice(0,10);
    kpiDate.value = todayStr;

    function addMonths(dateStr, delta){
      const d = new Date(dateStr + "T00:00:00");
      d.setMonth(d.getMonth() + delta);
      return d.toISOString().slice(0,10);
    }
    chartTo.value = todayStr;
    chartFrom.value = addMonths(todayStr, -12);

    // ===== Helpers =====
    function fmt(n){
      if (n === null || n === undefined) return "—";
      if (typeof n === "number") {
        if (n > 0 && n <= 1) return (n*100).toFixed(2) + "%";
        return n.toLocaleString("es-GT");
      }
      return n;
    }

    function levelByPct(p, good, warn){
      if (p >= good) return "good";
      if (p >= warn) return "warn";
      return "bad";
    }

    function showKpis(row){
      const reg = row.registros ?? 0;
      const ven = row.ventas ?? 0;

      const contact = Number(row.contactabilidad ?? 0);
      const efect  = Number(row.efectividad ?? 0);
      const rend   = Number(row.rendimiento ?? 0);

      const clsContact = levelByPct(contact, 0.35, 0.25);
      const clsEfect   = levelByPct(efect,  0.35, 0.20);
      const clsRend    = levelByPct(rend,   0.20, 0.10);

      const items = [
        ["Registros", reg, "neutral"],
        ["Ventas", ven, "neutral"],
        ["Contactabilidad", fmt(contact), clsContact],
        ["Efectividad", fmt(efect), clsEfect],
        ["Rendimiento", fmt(rend), clsRend],
      ];

      kpisDiv.innerHTML = `
        <div class="kpisGrid">
          ${items.map(([k,v,cls]) => `
            <div class="kpi">
              <strong>${k}</strong>
              <span class="badge ${cls === "neutral" ? "" : cls}">${v}</span>
            </div>
          `).join("")}
        </div>
      `;
    }

    function monthStart(dateStr){
      return dateStr.slice(0,7) + "-01";
    }

    // ===== KPIs (tabla diaria / mensual) =====
    async function loadCampaigns(){
      status.textContent = "Cargando campañas...";

      const period = periodSel.value;
      const dateVal = (period === "daily") ? kpiDate.value : monthStart(kpiDate.value);
      const table = (period === "daily") ? "kpi_daily" : "kpi_monthly";
      const dateField = (period === "daily") ? "kpi_date" : "kpi_month";

      const { data, error } = await sb
        .from(table)
        .select("campaign")
        .eq(dateField, dateVal);

      if (error) { status.textContent = "Error campañas: " + error.message; return; }

      const uniq = [...new Set((data || []).map(x => x.campaign))].sort();
      const options = [
        `<option value="${ALL_CAMPAIGNS_VALUE}">TODAS</option>`,
        ...uniq.map(c => `<option value="${c}">${c}</option>`)
      ];
      campaignSel.innerHTML = options.join("");

      status.textContent = uniq.length ? "Campañas cargadas." : "No hay campañas para ese filtro.";
    }

    async function loadKpis(){
      kpisDiv.innerHTML = "";
      status.textContent = "Buscando KPIs...";

      const period = periodSel.value;
      const dateVal = (period === "daily") ? kpiDate.value : monthStart(kpiDate.value);
      const table = (period === "daily") ? "kpi_daily" : "kpi_monthly";
      const dateField = (period === "daily") ? "kpi_date" : "kpi_month";
      const camp = campaignSel.value;

      if (camp === ALL_CAMPAIGNS_VALUE){
        status.textContent = "Para KPIs selecciona una campaña específica (TODAS es solo para gráficas).";
        return;
      }

      const { data, error } = await sb
        .from(table)
        .select("*")
        .eq(dateField, dateVal)
        .eq("campaign", camp)
        .limit(1);

      if (error) { status.textContent = "Error KPIs: " + error.message; return; }
      if (!data || data.length === 0){
        status.textContent = "No hay KPIs para ese filtro.";
        return;
      }

      showKpis(data[0]);
      status.textContent = "OK.";
    }

    // ===== Profile (operators) =====
    async function loadMyProfile(){
      const { data: { session } } = await sb.auth.getSession();
      if (!session?.user) return null;

      const { data, error } = await sb
        .from("operators")
        .select("operator_name, operator_code, role")
        .eq("auth_user_id", session.user.id)
        .limit(1);

      if (error) return null;
      return (data && data.length) ? data[0] : null;
    }

    async function loadOperatorsList(){
      chartStatus.textContent = "Cargando operadores...";
      const { data, error } = await sb
        .from("operators")
        .select("operator_code, operator_name, role")
        .eq("role", "operator")
        .order("operator_name", { ascending: true });

      if (error) {
        chartStatus.textContent = "Error leyendo operators (RLS): " + error.message;
        operatorPick.innerHTML = "";
        return;
      }

      const rows = data || [];
      operatorPick.innerHTML = rows.map(o =>
        `<option value="${o.operator_code}">${o.operator_name} (${o.operator_code})</option>`
      ).join("");

      chartStatus.textContent = rows.length ? "Operadores cargados." : "No hay operadores visibles (RLS).";
    }

    // ===== Chart (FIX anti-loop + destroy seguro + escala estable) =====
    let chart = null;

    function destroyChart(){
      try{
        if (chart){
          chart.destroy();
          chart = null;
        }
      } catch(e){
        chart = null;
      }
      const canvas = $("salesChart");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }

    function niceStep(maxVal){
      if (maxVal <= 10) return 1;
      const rough = maxVal / 6;
      const pow = Math.pow(10, Math.floor(Math.log10(rough)));
      const n = rough / pow;
      let m = 1;
      if (n <= 1) m = 1;
      else if (n <= 2) m = 2;
      else if (n <= 5) m = 5;
      else m = 10;
      return m * pow;
    }

    function makeChart(labels, values){
      const ctx = $("salesChart").getContext("2d");
      destroyChart();

      const maxVal = Math.max(...values, 0);
      const step = niceStep(maxVal || 1);
      const maxAxis = Math.ceil((maxVal || 1) / step) * step;

      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Ventas",
            data: values
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // ok porque fijamos altura con CSS + chartWrap relative
          plugins: { legend: { display: true } },
          scales: {
            y: {
              min: 0,
              max: maxAxis,
              ticks: {
                stepSize: step,
                precision: 0,
                callback: (v) => Number(v).toLocaleString("es-GT")
              }
            }
          }
        }
      });
    }

    let loadingChart = false;

    async function loadSalesChart(){
      if (loadingChart) return;
      loadingChart = true;
      $("btnLoadChart").disabled = true;

      try{
        chartStatus.textContent = "Cargando gráfico...";

        const scope = scopeSel.value; // me | all | operator
        const mode = chartModeSel.value; // monthly | daily
        const myProf = await loadMyProfile();
        const myCode = myProf?.operator_code;

        const camp = campaignSel.value;
        const isAllCampaigns = (camp === ALL_CAMPAIGNS_VALUE);

        const from = chartFrom.value;
        const to = chartTo.value;

        if (!from || !to){
          chartStatus.textContent = "Selecciona Desde y Hasta.";
          destroyChart();
          return;
        }
        if (from > to){
          chartStatus.textContent = "Rango inválido: Desde es mayor que Hasta.";
          destroyChart();
          return;
        }

        const opCode =
          (scope === "all") ? null :
          (scope === "operator") ? operatorPick.value :
          myCode;

        let view = "";
        let q = null;

        if (mode === "monthly"){
          const fromM = monthStart(from);
          const toM = monthStart(to);

          if (scope === "all" && isAllCampaigns){
            view = "kpi_monthly_global_total";
            q = sb.from(view).select("kpi_month, ventas_total")
              .gte("kpi_month", fromM).lte("kpi_month", toM)
              .order("kpi_month", { ascending: true });

          } else if (scope === "all" && !isAllCampaigns){
            view = "kpi_monthly_global_total_campaign";
            q = sb.from(view).select("kpi_month, ventas_total")
              .eq("campaign", camp)
              .gte("kpi_month", fromM).lte("kpi_month", toM)
              .order("kpi_month", { ascending: true });

          } else {
            if (!opCode){
              chartStatus.textContent = "Selecciona operador.";
              destroyChart();
              return;
            }

            if (isAllCampaigns){
              view = "kpi_monthly_operator_total";
              q = sb.from(view).select("kpi_month, ventas_total")
                .eq("operator_code", opCode)
                .gte("kpi_month", fromM).lte("kpi_month", toM)
                .order("kpi_month", { ascending: true });
            } else {
              view = "kpi_monthly_operator_total_campaign";
              q = sb.from(view).select("kpi_month, ventas_total")
                .eq("operator_code", opCode).eq("campaign", camp)
                .gte("kpi_month", fromM).lte("kpi_month", toM)
                .order("kpi_month", { ascending: true });
            }
          }

          chartTitle.textContent = `Ventas por Mes (${fromM.slice(0,7)} a ${toM.slice(0,7)})`;

          const { data, error } = await q;
          if (error){
            chartStatus.textContent = `Error (${view}): ${error.message}`;
            destroyChart();
            return;
          }

          const rows = data || [];
          if (!rows.length){
            chartStatus.textContent = "Sin datos para ese rango/filtro.";
            destroyChart();
            return;
          }

          const labels = rows.map(r => String(r.kpi_month).slice(0,7));
          const values = rows.map(r => Number(r.ventas_total || 0));

          makeChart(labels, values);
          chartStatus.textContent = "OK.";

        } else {
          // DAILY
          if (scope === "all" && isAllCampaigns){
            view = "kpi_daily_global_total";
            q = sb.from(view).select("kpi_date, ventas_total")
              .gte("kpi_date", from).lte("kpi_date", to)
              .order("kpi_date", { ascending: true });

          } else if (scope === "all" && !isAllCampaigns){
            view = "kpi_daily_global_total_campaign";
            q = sb.from(view).select("kpi_date, ventas_total")
              .eq("campaign", camp)
              .gte("kpi_date", from).lte("kpi_date", to)
              .order("kpi_date", { ascending: true });

          } else {
            if (!opCode){
              chartStatus.textContent = "Selecciona operador.";
              destroyChart();
              return;
            }

            if (isAllCampaigns){
              view = "kpi_daily_operator_total";
              q = sb.from(view).select("kpi_date, ventas_total")
                .eq("operator_code", opCode)
                .gte("kpi_date", from).lte("kpi_date", to)
                .order("kpi_date", { ascending: true });
            } else {
              view = "kpi_daily_operator_total_campaign";
              q = sb.from(view).select("kpi_date, ventas_total")
                .eq("operator_code", opCode).eq("campaign", camp)
                .gte("kpi_date", from).lte("kpi_date", to)
                .order("kpi_date", { ascending: true });
            }
          }

          chartTitle.textContent = `Ventas por Día (${from} a ${to})`;

          const { data, error } = await q;
          if (error){
            chartStatus.textContent = `Error (${view}): ${error.message}`;
            destroyChart();
            return;
          }

          const rows = data || [];
          if (!rows.length){
            chartStatus.textContent = "Sin datos para ese rango/filtro.";
            destroyChart();
            return;
          }

          const labels = rows.map(r => String(r.kpi_date));
          const values = rows.map(r => Number(r.ventas_total || 0));

          makeChart(labels, values);
          chartStatus.textContent = "OK.";
        }

      } finally {
        loadingChart = false;
        $("btnLoadChart").disabled = false;
      }
    }

    // ===== UI refresh =====
    async function refreshAuthUI(){
      const { data: { session } } = await sb.auth.getSession();
      if (session?.user){
        loginCard.classList.add("hide");
        appCard.classList.remove("hide");

        const prof = await loadMyProfile();
        if (prof?.operator_name){
          userInfo.textContent = `Sesión: ${prof.operator_name} (${session.user.email})`;
        } else {
          userInfo.textContent = "Sesión: " + session.user.email;
        }

        // supervisor zone
        if (prof?.role === "supervisor"){
          supervisorZone.classList.remove("hide");
          await loadOperatorsList();
        } else {
          supervisorZone.classList.add("hide");
        }

        await loadCampaigns();
      } else {
        loginCard.classList.remove("hide");
        appCard.classList.add("hide");
        loginMsg.textContent = "";
      }
    }

    // ===== Events (ASEGÚRATE QUE SOLO EXISTAN UNA VEZ) =====
    $("btnLogin").addEventListener("click", async () => {
      loginMsg.textContent = "Ingresando...";
      const email = $("email").value.trim();
      const password = $("password").value;

      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error){
        loginMsg.textContent = "Error: " + error.message;
        return;
      }
      await refreshAuthUI();
    });

    $("btnLogout").addEventListener("click", async () => {
      await sb.auth.signOut();
      await refreshAuthUI();
    });

    $("btnLoad").addEventListener("click", loadKpis);
    kpiDate.addEventListener("change", loadCampaigns);
    periodSel.addEventListener("change", loadCampaigns);

    scopeSel.addEventListener("change", () => {
      operatorPickWrap.classList.toggle("hide", scopeSel.value !== "operator");
    });

    // IMPORTANTE: SOLO UNA VEZ
    $("btnLoadChart").addEventListener("click", loadSalesChart);

    refreshAuthUI();
  </script>
</body>
</html>
